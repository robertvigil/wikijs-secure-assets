# Wiki.js Secure and Public Assets - Nginx Configuration
# Add these location blocks to your existing Wiki.js Nginx server block
# Location: /etc/nginx/sites-available/wiki (or your Wiki.js config file)

# ============================================================================
# INTEGRATION NOTE: Using with wikijs-jwt-auth
# ============================================================================
# If using wikijs-jwt-auth service, add these location blocks BEFORE the
# /secure/ rewrite rule below. Use ^~ modifier to prevent regex matching:
#
#   location ^~ /secure/login {
#       proxy_pass http://localhost:3004/;
#       # ... proxy headers
#   }
#
#   location ^~ /api/ {
#       proxy_pass http://localhost:3004;
#       # ... proxy headers
#   }
#
# See: https://github.com/yourusername/wikijs-jwt-auth for full configuration

# ============================================================================
# PUBLIC ASSETS - No authentication required
# ============================================================================
# URL Pattern: /public/{FILENAME}
# File location: /home/user/public-assets/
# Note: URL uses /public/ but directory is /public-assets/
location /public/ {
    alias /home/user/public-assets/;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;

    # Cache for 1 hour (public caching)
    expires 1h;
    add_header Cache-Control "public, max-age=3600";

    # Disable directory listing
    autoindex off;
}

# ============================================================================
# SECURE ASSETS - Group-based authentication
# ============================================================================
# URL Pattern: /secure/{GROUP_NAME}/{FILE_PATH}
# File location: /home/user/secure-assets/{GROUP_NAME}/{FILE_PATH}
# Note: URL uses /secure/ but directory is /secure-assets/
location ~ ^/secure/([^/]+)/?(.*)$ {
    # $1 = group name (first folder - e.g., "developers")
    # $2 = asset path (everything after - can include subfolders and directories)

    # Validate user is in the required group
    auth_request /auth-validate;
    auth_request_set $auth_status $upstream_status;

    # Error handling - returns 403 without redirect
    error_page 403 = @auth_error;

    # Serve from disk
    alias /home/user/secure-assets/$1/$2;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;

    # Cache but always revalidate to ensure auth is checked
    add_header Cache-Control "private, no-cache, must-revalidate";
    expires 0;

    # Disable directory listing
    autoindex off;
}

# Internal auth validation endpoint
location = /auth-validate {
    internal;

    # Extract group and asset from original URI
    set $group_name '';
    set $asset_path '';

    # Parse /secure/{GROUP}/{PATH} pattern
    if ($request_uri ~ "^/secure/([^/]+)/?(.*)$") {
        set $group_name $1;
        set $asset_path $2;
    }

    # Call auth service (use 127.0.0.1 to avoid DNS lookup)
    proxy_pass http://127.0.0.1:3002/auth/$group_name/$asset_path;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Original-URI $request_uri;
}

# Auth error page - returns 403 without redirect
# This allows pages with mixed permissions to still display
location @auth_error {
    # Return 403 without redirect so other images on page can still load
    default_type text/html;
    return 403 '<!DOCTYPE html><html><head><title>Access Denied</title></head><body style="margin:0;padding:20px;text-align:center;background:#f5f5f5;"><div style="max-width:400px;margin:50px auto;padding:30px;background:white;border:1px solid #ddd;border-radius:8px;"><h2 style="color:#d32f2f;margin:0 0 10px 0;">Access Denied</h2><p style="color:#666;margin:0;">You need to be in the appropriate group to view this asset.</p></div></body></html>';
}

# ============================================================================
# INSTALLATION NOTES
# ============================================================================
# 1. Replace /home/user with your actual user home directory
# 2. Add these location blocks to your existing Wiki.js server block
#    (inside the server { } block that handles Wiki.js)
# 3. Create the required directories:
#    mkdir -p /home/user/public-assets
#    mkdir -p /home/user/secure-assets
#    chmod 755 /home/user/public-assets
#    chmod 755 /home/user/secure-assets
#    chmod 751 /home/user  # Allow www-data to traverse
# 4. Test configuration: sudo nginx -t
# 5. Reload Nginx: sudo systemctl reload nginx
# 6. Ensure asset-auth service is running on port 3002
